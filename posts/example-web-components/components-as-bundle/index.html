<!doctype html><html lang=en-us><head><title>Components as Bundle // Notes of bvfnbk</title><link rel="shortcut icon" href=/favicon.ico><meta charset=utf-8><meta name=generator content="Hugo 0.113.0"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="bvfnbk"><meta name=description content><link rel=stylesheet href=https://bvfnbk.github.io/css/main.min.643edd862b12f1964ab47ccc8e9fc249b31e947d123dc806b0d1aa1e3aaa6325.css></head><body><header class=side-navigation><a href=https://bvfnbk.github.io/><img class=avatar src=/avatar.png alt=bvfnbk></a><h1>Notes of bvfnbk</h1><nav class=menu><a class=item href=/>Home</a>
/
<a class=item href=/tags/>Tags</a>
/
<a class=item href=/about/>About</a></nav><p>Software development and other stuff.</p><div class=social><a href=https://github.com/bvfnbk target=_blank rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></div></header><main class=main><article class=post><header class=header><h1 class=title>Components as Bundle</h1><div class=meta><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Mar 20, 2023</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>7 min read</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg><a class=tag href=https://bvfnbk.github.io/tags/web/>web</a>
<a class=tag href=https://bvfnbk.github.io/tags/html/>html</a>
<a class=tag href=https://bvfnbk.github.io/tags/typescript/>typescript</a>
<a class=tag href=https://bvfnbk.github.io/tags/events/>events</a>
<a class=tag href=https://bvfnbk.github.io/tags/test/>test</a>
<a class=tag href=https://bvfnbk.github.io/tags/webpack/>webpack</a>
<a class=tag href=https://bvfnbk.github.io/tags/jest/>jest</a></div></div></header><div class=content><p>The latest <a href=/posts/example-web-components/message-input/>example</a> defined another component which is transpiled,
together with the <a href=/posts/example-web-components/ts-hello-message/>first</a> component into a <code>dist/</code> directory containing
an <code>index.html</code> ready to use the components.</p><p>There is nothing especially wrong with the proposed structure - one <em>can</em> build components using <em>TypeScript</em> starting
from this foundation. However, the build layout contains quite a few errors and pitfalls making it more difficult than
actually required:</p><ul><li><code>import</code> of other modules not possible without further ado,</li><li>components and other modules need to be included in <code>index.html</code> to be usable,</li><li>paths to include scripts must match the location the transpiled files are put into</li></ul><p>and there are definitely more which I have not found yet.</p><p>The sources to this web component and others can be found on GitHub: <a href=https://github.com/bvfnbk/example-web-components>https://github.com/bvfnbk/example-web-components</a></p><h2 id=an-excuse->An Excuse &mldr;</h2><p>Originally, this whole project was intended to develop an environment to work with web components using <em>small</em> (if not
<em>minimal</em>) increments:</p><ul><li>adding one small feature after the other without loosing any functionality and</li><li>each step easy to understand</li></ul><p>until I reach a sufficiently convenient setup or end up using <em>React</em>, deleting the posts/repos again.</p><p>Unfortunately, I stumbled across a problem for which I failed to spot the immediate (minimal) fix. Too early, I
considered the creation of a bundle to be the only practical solution to the problem at hand.</p><p>Now, I do not believe this anymore.</p><h2 id=comments-on-the-sources>Comments on the Sources</h2><p>All <code>.ts</code> files have initially been put into the same <code>src/ts/</code> directory. This works for a proof of concept but quickly
gets messy when other <em>TypeScript</em> modules are being added (especially when following a &ldquo;one class/interface/enumeration
per file&rdquo; rule).</p><h3 id=step-1-add-more-structure>Step 1: Add More Structure</h3><p>Currently, I have only web components, thus, all <code>.ts</code> files are moved to <code>src/ts/components/</code>. Changing the <code>src</code>
paths in the corresponding <code>&lt;script></code> tags in the <code>src/public/index.html</code> file should be sufficient. However, the
<em>TypeScript</em> configuration causes the compiler to put all results directly into <code>dist/js/</code> source - flat, without
matching the source directory structure.</p><p>This can be easily fixed: update <code>tsconfig.json</code> and add the property <code>rootDir</code> pointing to <code>src/ts</code> to the
<code>compilerOptions</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;compilerOptions&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;rootDir&#34;</span>: <span style=color:#e6db74>&#34;src/ts&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Rebuild <code>dist/</code> and open <code>dist/index.html</code>.</p><blockquote><p><strong>Please note:</strong> Building the bundle fails with this setting recently. <em>Why</em> is not 100% clear - eventually
<em>TypeScript</em> has been updated or the <code>ts-loader</code>. However, this setting was only a quick fix on the way to the actual
bundle.</p><p>This is not required once the bundle has been created. So, skip it and jump to the bundle creation.</p></blockquote><h3 id=step-2-create-entry-point>Step 2: Create Entry Point</h3><p>The initialization code is currently distributed across several files:</p><ul><li>the <code>src/public/index.html</code> …<ul><li>… includes the components using <code>&lt;script src="..."></code> tags and</li><li>… registers the required event listeners which actually perform the update.</li></ul></li><li>the individual components register themselves using <code>customElements.define(...)</code>.</li></ul><p>OK, not so many files, but this may change in the future. This change suggests the creation of a <code>src/ts/index.ts</code> file
which, in the end, should look like the following snippet:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>HelloMessage</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;./components/HelloMessage&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>MessageInput</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;./components/MessageInput&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>customElements</span>.<span style=color:#a6e22e>define</span>(<span style=color:#e6db74>&#39;hello-message&#39;</span>, <span style=color:#a6e22e>HelloMessage</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>customElements</span>.<span style=color:#a6e22e>define</span>(<span style=color:#e6db74>&#39;message-input&#39;</span>, <span style=color:#a6e22e>MessageInput</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>greeter</span> <span style=color:#f92672>=</span> document.<span style=color:#a6e22e>getElementById</span>(<span style=color:#e6db74>&#39;greeter&#39;</span>);
</span></span><span style=display:flex><span>document.<span style=color:#a6e22e>getElementById</span>(<span style=color:#e6db74>&#39;msgInput&#39;</span>)<span style=color:#f92672>!</span>.<span style=color:#a6e22e>addEventListener</span>(
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;MessageUpdateEvent&#39;</span>,
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>event</span>: <span style=color:#66d9ef>Event</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>custom</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>event</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>CustomEvent</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>greeter</span><span style=color:#f92672>!</span>.<span style=color:#a6e22e>setAttribute</span>(<span style=color:#e6db74>&#39;name&#39;</span>, <span style=color:#a6e22e>custom</span>.<span style=color:#a6e22e>detail</span>);
</span></span><span style=display:flex><span>  });
</span></span></code></pre></div><h4 id=a-short-overview-of-es6-modules>A Short Overview of ES6 Modules</h4><p>Recent web browser allow the usage of ES6 modules. This allows the definition of a module, e.g. the component defined in
<code>dist/js/components/HelloMessage.js</code> as an <em>ES6 Module</em>, i.e.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>HelloMessage</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>HTMLElement</span> {}
</span></span></code></pre></div><p>The module defines a <em>default export</em> which can be used in <em>other</em> ES6 modules, e.g. the entry point <code>dist/js/index.js</code>
like</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>HelloMessage</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;./components/HelloMessage.js&#39;</span>;
</span></span></code></pre></div><p>The module <code>js/index.js</code> can be included using a <code>&lt;script></code> tag</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#f92672>script</span> <span style=color:#a6e22e>src</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;js/index.js&#34;</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;module&#34;</span>&gt;&lt;/<span style=color:#f92672>script</span>&gt;
</span></span></code></pre></div><p><strong>Please note:</strong></p><ul><li>The attribute <code>type="module"</code> is required for the web browser to handle the <em>JavaScript</em> file as module.</li><li>The <code>import</code> instructions in <code>js/index.js</code> cause the browser to load the named modules from the given path.</li><li>The page must be served from an HTTP service (web browsers will not load ES6 modules from <code>file://</code> URLs).</li><li>The browser composes an HTTP request given the <em>relative</em> path to the module to be imported.</li><li>The <code>.js</code> extension is required; the browser gets an <code>404</code> otherwise.</li></ul><h4 id=quick-fix-import-instructions>Quick Fix <code>import</code> Instructions</h4><p>Update <code>src/ts/index.ts</code> and append the <code>.js</code> extension to the module <code>import</code> instructions, i.e.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>HelloMessage</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;./components/HelloMessage.js&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>MessageInput</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;./components/MessageInput.js&#39;</span>;
</span></span></code></pre></div><p>Build <code>dist/</code> and open <code>dist/index.html</code> and the page should work again. The <em>Karma</em> tests are not running though:
<em>Karma</em> fails to be able to import the components-under-test as these are ES6 modules which <code>export</code> themselves and
<em>Karma</em> seems to not understand (at least without further ado).</p><h4 id=implemented-fix>Implemented &ldquo;Fix&rdquo;</h4><h5 id=creating-a-bundle>Creating a Bundle</h5><p><strong>Please note:</strong> There are several tools out there for bundle creation, e.g.</p><ul><li><em>Webpack</em></li><li><em>Parcel</em></li><li><code>esbuild</code></li><li><em>Vite</em>.</li></ul><p>to name but a few from which I chose <em>Webpack</em> (seems to be the top dog; eventually about to get replaced with <em>Vite</em> or
whatever). Install it with</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>npm install --save-dev webpack webpack-cli ts-loader
</span></span></code></pre></div><p>and create the following <code>webpack.config.js</code> in the working directory:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>path</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;path&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>mode</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;development&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>entry</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;./src/ts/index.ts&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>devtool</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;inline-source-map&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>module</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rules</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>test</span><span style=color:#f92672>:</span> <span style=color:#e6db74>/\.ts$/</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>use</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;ts-loader&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>exclude</span><span style=color:#f92672>:</span> <span style=color:#e6db74>/node_modules/</span>,
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>resolve</span> <span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>extensions</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;.ts&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;.js&#39;</span>
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>output</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>filename</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;bundle.js&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>path</span> <span style=color:#f92672>:</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>__dirname</span>, <span style=color:#e6db74>&#39;dist&#39;</span>, <span style=color:#e6db74>&#39;js&#39;</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>Please note:</strong></p><ul><li>This defines the entry point <code>src/ts/index.ts</code> from which <em>Webpack</em> builds the tree of the modules to be included in
the bundle.</li><li>It adds a rule to pipe all <code>.ts</code> files through the <code>ts-loader</code>.</li><li>It defines the desired output file, namely <code>dist/js/bundle.js</code>.</li></ul><p>Now, fix <code>src/public/index.html</code> to load the <code>dist/js/bundle.js</code> file and <em>not</em> the entry point directly. It should look
like</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span><span style=color:#75715e>&lt;!doctype html&gt;</span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>html</span> <span style=color:#a6e22e>lang</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;en&#34;</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>head</span>&gt;
</span></span><span style=display:flex><span>  &lt;<span style=color:#f92672>meta</span> <span style=color:#a6e22e>charset</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;UTF-8&#34;</span>&gt;
</span></span><span style=display:flex><span>  &lt;<span style=color:#f92672>meta</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;viewport&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>content</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0&#34;</span>&gt;
</span></span><span style=display:flex><span>  &lt;<span style=color:#f92672>meta</span> <span style=color:#a6e22e>http-equiv</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;X-UA-Compatible&#34;</span> <span style=color:#a6e22e>content</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;ie=edge&#34;</span>&gt;
</span></span><span style=display:flex><span>  &lt;<span style=color:#f92672>title</span>&gt;Example / Web Components / Greeter&lt;/<span style=color:#f92672>title</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>head</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>body</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>message-input</span> <span style=color:#a6e22e>id</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;msgInput&#34;</span>&gt;&lt;/<span style=color:#f92672>message-input</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>br</span>/&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>hello-message</span> <span style=color:#a6e22e>id</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;greeter&#34;</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Friend&#34;</span>&gt;&lt;/<span style=color:#f92672>hello-message</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>script</span> <span style=color:#a6e22e>src</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;js/bundle.js&#34;</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;module&#34;</span>&gt;&lt;/<span style=color:#f92672>script</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>body</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>html</span>&gt;
</span></span></code></pre></div><p>The script section can be updated in the <code>package.json</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;scripts&#34;</span> : {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;webpack&#34;</span> : <span style=color:#e6db74>&#34;webpack&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;build&#34;</span> : <span style=color:#e6db74>&#34;npm-run-all prepare webpack copy-assets&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The <code>compile</code> script (using <code>tsc</code>) is not required anymore for building: <em>Webpack</em> handles all <em>TypeScript</em> files
through its <code>ts-loader</code>. Thus, it can be <em>replaced</em> with a <em>webpack</em> script.</p><p>Now try building it and open <code>dist/index.html</code>.</p><h5 id=fixing-the-tests>Fixing the Tests</h5><p><em>Webpack</em> does not fix the tests though: <em>Karma</em> still cannot handle the <code>export</code> instructions. I tried out different
configurations, different packages and plugins to handle <em>TypeScript</em>, different preprocessors or transforms to
handle the tests for <em>Karma</em> and, unfortunately, to no avail.</p><p><strong>Please note:</strong> Most certainly, the problem sits in front of the keyboard: I am sure, that I am not the only one trying
to test <em>TypeScript</em> front-end code with <em>Karma</em> and <em>Jasmine</em>.</p><p>But never fear, I was not especially happy with the way <em>Karma</em> and <em>Jasmine</em> worked anyway. <em>Karma</em> sometimes failed to
start the browsers and the reports were not as I expected (I tried different output formats).</p><p>This is the reason I did not want to put more efforts into getting <em>Karma</em> to work and why I actually switched to
<em>Jest</em>.</p><p>First remove all <em>Karma</em> and <em>Jasmine</em> related packages and install</p><ul><li><code>@types/jest</code></li><li><code>jest</code></li><li><code>jest-environment-jsdom</code> and</li><li><code>ts-jest</code></li></ul><p>Create a <em>Jest</em> configuration file <code>jest.config.js</code> with the following contents</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>/** @type {import(&#39;ts-jest&#39;).JestConfigWithTsJest} */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>preset</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;ts-jest&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>testEnvironment</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;jsdom&#39;</span>,
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>and remove the <code>karma</code> script from the <code>package.json</code>. The <code>test</code> script may then simply call <code>jest</code>.</p><p>On the one hand, <em>Jest</em> uses the same test specification language (<code>describe</code>, <code>it</code> etc.) but on the other hand, there
are at least <em>some</em> differences:</p><ul><li><p>Assertions:</p><ul><li><code>toBeTrue()</code> is actually <code>toBeTruthy()</code></li><li><code>toBeFalse()</code> is actually <code>toBeFalsy()</code></li></ul></li><li><p>Mocking: No <code>spyOn</code> in <em>Jest</em> but <em>explicit</em> patching of the object, e.g.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>event</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Event</span>(<span style=color:#e6db74>&#39;whatever&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>stopPropagation</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>jest</span>.<span style=color:#a6e22e>fn</span>(() <span style=color:#f92672>=&gt;</span> {});
</span></span></code></pre></div></li></ul><p>There is still an issue that some tests fail: <em>Jest</em> uses a specific <em>environment</em> for front-end tests. This environment
is required to provide <code>document</code> and <code>customElements</code> to the tests and is rather picky when it comes to the asserted
property, e.g. a test checking <code>innerText</code> of a component which updates its <code>innerHTML</code> property will fail.</p><p><em>Karma</em> uses the browsers to run the tests and those environments are more forgiving.</p><p><strong>Please note:</strong> The tests are not watched anymore and must be <em>explicitly</em> run - but they are running faster (on the
good side).</p><h2 id=summary>Summary</h2><p>Bundling the <em>TypeScript</em> modules has been added to the
<a href=/posts/example-web-components/message-input/>Web Component</a> and tests have been made to work (again) -
albeit by switching the test framework. Some minor improvements have been implemented to prepare the grounds for future
features (e.g. hot module reloading etc.).</p><h2 id=resources>Resources</h2><ul><li><a href=https://caniuse.com/es6-module>https://caniuse.com/es6-module</a></li><li><a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Modules>https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Modules</a></li><li><a href=https://webpack.js.org/concepts/>https://webpack.js.org/concepts/</a></li></ul></div></article></main></body></html>